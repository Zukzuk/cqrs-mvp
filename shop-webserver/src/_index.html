<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Orders Dashboard</title>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
  <style>
    body {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: #f8fafc;
      margin: 0;
      padding: 2rem;
    }

    h1 {
      margin-top: 0;
    }

    button {
      background: #2563eb;
      color: #fff;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-bottom: 1rem;
    }

    button:hover {
      background: #1e40af;
    }

    .orders-card {
      max-width: 960px;
      margin-top: 1rem;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, .06);
      overflow: hidden;
      background: #fff;
    }

    .orders-header {
      padding: .85rem 1rem;
      border-bottom: 1px solid #e5e7eb;
      background: #f1f5f9;
      font-weight: 600;
      font-size: 16px;
    }

    table.orders {
      width: 100%;
      border-collapse: collapse;
    }

    table.orders th,
    table.orders td {
      padding: .7rem .9rem;
      border-bottom: 1px solid #f1f5f9;
      text-align: left;
      font-size: 14px;
    }

    table.orders th {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .02em;
      color: #64748b;
      background: #f8fafc;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: .35rem;
      padding: .2rem .6rem;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
    }

    .pill.pending {
      background: #fff7ed;
      color: #9a3412;
    }

    /* amber */
    .pill.created {
      background: #ecfeff;
      color: #155e75;
    }

    /* cyan */
    .pill.completed {
      background: #ecfdf5;
      color: #065f46;
    }

    /* green */
    .pill.failed {
      background: #fef2f2;
      color: #991b1b;
    }

    /* red */
    .muted {
      color: #64748b;
      font-size: 12px;
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }

    .spin {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 2px solid currentColor;
      border-top-color: transparent;
      display: inline-block;
      animation: spin .8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>
  <h1>Your Orders</h1>
  <button onclick="createOrder()">Create Order</button>

  <div id="orders-container" class="orders-card">
    <div class="orders-header">Orders</div>
    <table class="orders" id="orders-table" aria-label="Orders">
      <thead>
        <tr>
          <th>Order</th>
          <th>User</th>
          <th>Status</th>
          <th>Correlation&nbsp;ID</th>
          <th class="muted">Updated</th>
        </tr>
      </thead>
      <tbody id="orders-body"></tbody>
    </table>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const auth = { userId: params.get('userId') || 'user123' };

    // indexes so we can resolve pending rows by correlationId later
    const byOrderId = new Map();      // orderId -> <tr>
    const byCorrId = new Map();      // correlationId -> <tr>

    const socket = io('http://localhost:3000', {
      transports: ['websocket'],
      auth,
      reconnection: true,
      reconnectionAttempts: Infinity,
      reconnectionDelay: 1000
    });

    socket.on('connect_error', err => console.error('‚ùå [web-socket] connection error:', err.message));
    socket.on('disconnect', reason => console.warn('‚ö†Ô∏è [web-socket] disconnected:', reason));

    // Full snapshot (non-pending rows)
    socket.on('orders_snapshot', (orders) => {
      console.log('‚¨ÖÔ∏è [web-socket] receiving orders_snapshot:', orders);
      const tbody = document.getElementById('orders-body');
      // don't wipe pending rows; just upsert snapshot items
      orders.forEach(order => upsertOrderRow({
        orderId: order.orderId,
        userId: order.userId,
        status: order.status,
        correlationId: order.correlationId
      }, { pending: false }));
    });

    // Incremental updates: resolve any pending row by correlationId, then update
    socket.on('order_update', (update) => {
      console.log('‚¨ÖÔ∏è [web-socket] receiving order_update:', update);
      const { correlationId } = update || {};
      let tr = correlationId ? byCorrId.get(correlationId) : null;

      // If there's a pending row for this corrId, reuse it; otherwise, upsert by orderId
      if (tr) {
        upsertOrderRow(update, { reuseTr: tr, pending: false });
      } else {
        upsertOrderRow(update, { pending: false });
      }
    });

    // ===== Rendering / Upsert =====

    function statusClass(status, pending) {
      if (pending) return 'pending';
      const s = (status || '').toLowerCase();
      if (s.includes('fail') || s.includes('error')) return 'failed';
      if (s.includes('complete')) return 'completed';
      if (s.includes('create')) return 'created';
      return 'created';
    }

    function statusLabel(status, pending) {
      return pending ? 'Pending' : (status || 'Created');
    }

    function upsertOrderRow(order, opts = {}) {
      const { reuseTr = null, pending = false } = opts;
      const tbody = document.getElementById('orders-body');

      let { orderId, userId, status, correlationId } = order;
      // Some backends may return numeric IDs as strings ‚Äì normalize id for DOM
      const domId = (orderId !== undefined && orderId !== null) ? String(orderId) : 'pending';

      // Find or create row
      let tr = reuseTr || byOrderId.get(domId);
      const existed = !!tr;

      if (!tr) {
        tr = document.createElement('tr');
        tr.id = `order-${domId}`;
        tr.innerHTML = `
          <td class="order-cell mono"></td>
          <td class="user-cell"></td>
          <td class="status-cell"></td>
          <td class="corr-cell mono"></td>
          <td class="time-cell muted"></td>
        `;
      }

      // Update cells
      tr.querySelector('.order-cell').textContent = orderId != null ? `#${orderId}` : '#‚Äî';
      tr.querySelector('.user-cell').textContent = userId ?? '‚Äî';

      const pillCls = statusClass(status, pending);
      const pillText = statusLabel(status, pending);
      const spinner = pending ? '<span class="spin" aria-hidden="true"></span>' : '';
      tr.querySelector('.status-cell').innerHTML = `<span class="pill ${pillCls}">${spinner}${pillText}</span>`;

      tr.querySelector('.corr-cell').textContent = correlationId || '‚Äî';
      tr.querySelector('.time-cell').textContent = new Date().toLocaleTimeString();

      // Maintain indexes (corrId -> tr, orderId -> tr)
      if (correlationId) byCorrId.set(correlationId, tr);

      // If an existing pending row had id "order-pending" and we now know orderId, update the DOM id & map
      if (tr.id !== `order-${domId}`) {
        byOrderId.delete(tr.dataset.orderKey || tr.id.replace('order-', ''));
        tr.id = `order-${domId}`;
      }
      tr.dataset.orderKey = domId;
      byOrderId.set(domId, tr);

      // Insert at the top (latest first)
      if (!existed) {
        if (tbody.firstChild) tbody.insertBefore(tr, tbody.firstChild);
        else tbody.appendChild(tr);
      } else {
        // Move to top on every update
        if (tbody.firstChild !== tr) {
          tbody.insertBefore(tr, tbody.firstChild);
        }
      }
    }

    // ===== Emit CreateOrder and add a pending row once ACK =====

    const { v4: uuidV4 } = window.uuid;

    function createOrder() {
      // client picks an orderId to show immediately (you can change to let server assign)
      const provisionalOrderId = Date.now();
      const corrId = uuidV4();

      const cmd = {
        type: "CreateOrder",
        payload: { orderId: provisionalOrderId, total: 1 },
        correlationId: corrId
      };

      console.log('‚û°Ô∏è [web-socket] sending command:', cmd);

      socket.emit('command', cmd, (ack) => {
        console.log('‚úÖ [web-socket] command ACK:', ack);

        // Only render pending once ACK returns ok; add row with Pending UI.
        // We use the provisional orderId here; if the real update comes with a different orderId,
        // we‚Äôll merge by correlationId and update the row id.
        if (ack && ack.status === 'ok') {
          upsertOrderRow({
            orderId: provisionalOrderId,
            userId: auth.userId,
            status: 'Pending',
            correlationId: corrId
          }, { pending: true });
        } else {
          // Optional: show a failed row if ack.error exists
          upsertOrderRow({
            orderId: provisionalOrderId,
            userId: auth.userId,
            status: 'Failed',
            correlationId: corrId
          }, { pending: false });
        }
      });
    }

    console.log('üöÄ [http+wss] WebClient running on port 3001');
  </script>
</body>

</html>